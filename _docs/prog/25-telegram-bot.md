---
title: 25 — Как написать своего телеграм бота
---

# Как написать своего телеграм бота

## Содержание

* [Что такое telegram-бот](#что-такое-telegram-бот)
* [Обзор библиотек для создания ботов](#обзор-библиотек-для-создания-ботов)
* [Создание бота, сообщающего курс доллара на основе библиотеки **pyTelegramBotAPI**](#создание-бота,-сообщающего-курс-доллара-на-основе-библиотеки-pytelegrambotapi)
* [Создание бота для учета расходов на основе библиотеки **python-telegram-bot**](#создание-бота-для-учета-расходов-на-основе-библиотеки-python-telegram-bot)
* [Как заставить бота работать через прокси](#как-заставить-бота-работать-через-прокси)
* [Куда выложить бота чтобы он работал всегда](#куда-выложить-бота-чтобы-он-работал-всегда)


## Что такое telegram-бот

Думаю, что вы все пользовались ботами в телеграмме и не хуже меня знаете, что это такое. Но, что такое бот с точки зрения создания бота?

Telegram-бот - это программа, написанная на ЛЮБОМ языке программирования, которой можно посылать данные через одно из приложений телеграмм. К сожалению (или счастью), вы не можете посылать сообщения напрямую со своего телефона вашему кода на python. Чтобы все это работало, нужен сервер, который будет вас связывать. На самом деле так работает весь интернет и телеграмм со своими ботами не исключение.

![](static/25/telegram-bot-flow.svg)

На сайте telegram есть потрясающая документация для разработчиков ботов - <https://core.telegram.org/bots>. Это довольно обширный документ, описывающий буквально миллион возможностей телеграмм. Читая его, можно реализовать любого бота. Однако, делать это с нуля только по документации не такое простое задание как хотелось бы. Поэтому уже давно существуют библиотеки на python, который ОЧЕНЬ сильно упрощают жизнь создателям ботов.

## Обзор библиотек для создания ботов

Библиотек довольно много, но мы поговорим здесь о 2 из них:

- [pyTelegramBotAPI](https://github.com/eternnoir/pyTelegramBotAPI)
- [python-telegram-bot](https://github.com/python-telegram-bot/python-telegram-bot)

Эти библиотеки довольно похожи, но мне лично больше нравится `python-telegram-bot`. Она очень качественно написана да и статистика github говорит сама за себя.

На этой библиотеке и ботов написано больше и лайкают её побольше.

![](static/25/libs-vs.svg)

Самый просто бот - это тот, который отвечает вам то, что вы ему послали. Такой бот называется echo-bot. Давайте его напишем.

## Создание echo-bot на python-telegram-bot

Для начала нам нужно установить библиотеку. Если открыть главную страницу репозитория <https://github.com/python-telegram-bot/python-telegram-bot>, то там без труда можно найти команду для установки. Она начинается с `pip`. Откройте командную строку своего компьютера и вставьте туда эту строку (*как открыть командную строку нужно погуглить, если вы не знаете как это сделать*).

```
pip install python-telegram-bot --upgrade
```

После установки напишем нашего бота. Вот его код:

```python
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters


TOKEN = '<ваш токен>'


def command_start(update, context):
    update.message.reply_text('Привет!\nЯ бот, который почти ничего не умеет')


def handler_echo(update, context):
    message = 'Вы спросили у меня: ' + update.message.text
    message += '\nА я вам отвечу: ' + update.message.text
    update.message.reply_text(message)


def main():
    updater = Updater(TOKEN, use_context=True)

    dp = updater.dispatcher

    dp.add_handler(CommandHandler('start', command_start))

    dp.add_handler(MessageHandler(Filters.text, handler_echo))

    updater.start_polling()
    updater.idle()


if __name__ == '__main__':
    main()

```

Разберем этот код по косточкам.

```python
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters
```

Библиотека называется  **python-telegram-bot**, а вот **модуль**, который вы получаете - **telegram**. На этой строчке мы импортируем нужные нам сущности: `Updater`, `CommandHandler`, `MessageHandler`. Для чего каждая из них нужна далее.

```python
TOKEN = '<ваш токен>'
```

Присваиваем переменной `TOKEN` токен вашего бота. Что это такое и как его получить описано дальше в разделе [попросить бота у папы](#попросить-бота-у-папы)

```python
def command_start(update, context):
    update.message.reply_text('Привет!\nЯ бот, который почти ничего не умеет')
```

Это функция, которая будет вызвана, когда пользователь напишет боту `/start`. Имя этой функции произвольное. Главное, чтобы имя отражало смысл функции. Эта функция принимает 2 аргумента - `update` и `context`. Эти аргументы в эту фунцию передает `Updater`, который настраивается в функции `main` (об этом дальше).

Аргумент `update` - это обновление, которое присылает сервер телеграмма на запрос бота. Обновление - это обычно сообщения, которые пишет боту пользователь. Также обновлениями могут быть уведомления о том, что пользователь изменил или удалил какое-то сообщение. Подробное описание объекта `update` есть на сайте - [telegram.update](https://python-telegram-bot.readthedocs.io/en/stable/telegram.update.html).

Аругмент `context` - это некоторый контекст сообщения. Иными словами, этот состояние бота в тот момент, когда ваша функция обрабатывает сообщение. В переменной `context` можно, например, хранить данные, которыми можно будет воспользоваться при обработке следующего сообщения. Например, вы сообщаете пользователем курс доллара. Вы его будете не с потолка брать, а спрашивать у какого-то сервиса. Чтобы постоянно у сервиса не спрашивать, можно сохранить курс к себе и переспрашивать актуальный курс только на каждое 10 обращение к боту. Подробная описание объекта `context` есть на сайте - [telegram.ext.callbackcontext](https://python-telegram-bot.readthedocs.io/en/stable/telegram.ext.callbackcontext.html).

Внутри самой функции мы вызываем метод `update.message.reply_text` и передаем в него сообщение пользователю.

```python
def handler_echo(update, context):
    message = 'Вы спросили у меня: ' + update.message.text
    message += '\nА я вам отвечу: ' + update.message.text
    update.message.reply_text(message)
```

Это функция, которая будет вызвана, когда пользователь напишет боту текст. В этой функции мы отправим пользователю текст, который он послал боту, добавив к нему немного нашей фантазии. Получить текст, который отправил пользователь можно через переменную `update.message.text`.

Теперь разберемся с функцией **main**.

```python
updater = Updater(TOKEN, use_context=True)
```

Библиотека `python-telegram-bot` вводит свои абстракции для упрощения создания ботов. Одна из них - `Updater`. Как мы уже знаем, нельзя послать пользователю сообщение напрямую. Это всегда нужно делать через сервер telegram. В то же самое время, наш бот как-то должен узнать о сообщениях, которые ему шлют пользователи. Telegram это делает через рассылку обновлений. Как интернет-магазин шлет своим покупателям имейлы о новых поступлениями товара. Ваш бот должен подписаться на новые обновления, которые будет слать сервер telegram.

Чтобы вы вообще не думали о том, как это работает, библиотека предоставляет класс `Updater`. Да, мы с вами не знаем, что такое классы (хотя на самом деле мы ими постоянно пользуемся), но в работе с ними нет ничего сложного. В приведенном выше коде мы как-будто вызываем функцию `Updater`. Хотя на самом деле мы создаем новый экземпляр класса `Updater`. Главное, ему надо передать ваш токен и `use_context=True`. Второй аргумент делает так, чтобы в ваших функциях-обработчиках (command_start и handler_echo) появилась переменная `context`.

```python
dp = updater.dispatcher
```

Здесь мы создаем псевдоним `dp` класса `dispatcher`, который находится внутри `updater`. Это может показаться сложным, но если разобраться, то становится понятно.

`Updater` - это большой класс, который занимается большим количеством задач. Внутри себя класс `Updater` разбит на более маленькие классы, каждый выполняющий определенные функции. Это как компания, в которой есть отдел кадров, бухгалтерия, логисты и т.д.

Класс `dispatcher` - выполняет функцую связывания обновлений, которые шлет telegram с вашими функциями-обработчиками. Ведь вы же не думали, что вы просто написали функции и оно само заработало. Нужно увязать все воедино.

```python
dp.add_handler(CommandHandler('start', command_start))
```

Здесь мы как раз добавляем обработчик обновлений. Как вы, наверное, уже догадались обновления бывают разные. Пользоваль может отправить команду, может послать картинку или голосовое сообщение. Чтобы связать каждое конткретное обновление с обработчиком, нужно указать какое именно обновление какой обработчик обрабатывает.

С помощью `CommandHandler('start', command_start)` мы создаем обработчика команд. Причем первым аргументом мы говорим, какую именно команду обрабатывать - `start`. А вторым аргументом указываем, какая функцию эту команду должна обрабатывать.

```python
dp.add_handler(MessageHandler(Filters.text, handler_echo))
```

Здесь мы добавляем обработчик сообщений, а не команд. Сообщения бывают разные, поэтому мы первым аргументом передаем фильтр - `Filters.text`, который будет срабатывать, когда пользователь будет отправлять простое текстовое сообщение.

Это код реализует логику работы бота. А сам бот - это сущность на серверах telegram. Пока у нас нет бота и его надо создать. Давайте попросим это сделать отца всех ботов.

## Попросить бота у папы

Для создания ботов в telegram есть специальный бот - **BotFather**. Можете найти его в telegram по этому логину.

Процесс создания бота очень простой. На скрине все есть:

<img src="static/25/botfather.jpg" width="400">

В сообщении, которое тут скрыто будет токен, с которым вы всегда будете обращаться к серверам telegram. В нашем коде этот токен нужно присвоить переменной `TOKEN`. 

Он выглядит примерно следующим образом: `1226478115:AAHwuaJ6i9Sugv6wxqlOLym2H-do3oGli94`. У вас будет свой токен.

После того, как вы вставите токен в нужное место, можно запустить бота. Для этого в командной строке наберите (предполагается, что вы созранили код выше в файл bot.py)

```
python bot.py
```

После этого можно писать боту.

<img src="static/25/echo.jpg" width="400">

Если вместо того чтобы отвечать ваш бот молчит, а в консоли вы видите примерно такое:

```
  File "/Users/sapunovnik/Repos/github/tgbots-tutorial/.env/lib/python3.7/site-packages/telegram/utils/request.py", line 277, in get
    result = self._request_wrapper('GET', url, **urlopen_kwargs)
  File "/Users/sapunovnik/Repos/github/tgbots-tutorial/.env/lib/python3.7/site-packages/telegram/utils/request.py", line 231, in _request_wrapper
    raise NetworkError('urllib3 HTTPError {0}'.format(error))
telegram.error.NetworkError: urllib3 HTTPError HTTPSConnectionPool(host='api.telegram.org', port=443): Max retries exceeded with url: /bot105809050/getMe (Caused by ConnectTimeoutError(<telegram.vendor.ptb_urllib3.urllib3.connection.VerifiedHTTPSConnection object at 0x10fd05450>, 'Connection to api.telegram.org timed out. (connect timeout=5.0)'))
```

то могу вас поздравить, вы живете в стране, где запрещен telegram.

Чтобы это обойти нужно использовать прокси.


## Как заставить бота работать через прокси

Есть несколько видов proxy: socks5 и mtproto. Самый классный - это mtproto. Он использует проприетарный протокол telegram, его сложнее обнаружить и сложнее заблокировать. Библиотека python-telegram-bot не позволяет работать с этим видом прокси, поэтому мы будем использовать другой вид -  socks5.

Для socks5 нужно иметь адрес сервера прокси, порт, имя пользователя и пароль. Есть много источников, где все это можно взять. Нужно искать то, что работает так как эти прокси тоже постоянно блокируют.

Есть бот - @socks5_bot (найдите его по этому логину), у которого я нашел работающие прокси.

Чтобы заставить наш код работать с прокси, его надо чуть изменить.

Для начала нужно установить библиотеку `pysocks`.

```
pip install PySocks
```

И чуть изменить код в нашей функции `main`. Вместо 

```python
updater = Updater(TOKEN, use_context=True)
```

вставить:

```python
proxy_settings = {
    'proxy_url': 'socks5://orbtl.s5.opennetwork.cc:999',
    'urllib3_proxy_kwargs': {
        'username': '3571087',
        'password': 'iyyXSuti'
    }
}
updater = Updater(TOKEN, use_context=True, request_kwargs=proxy_settings)
```

Здесь

- `orbtl.s5.opennetwork.cc` - хост из ответа бота
- `999` - порт
- `3571087` - username
- `iyyXSuti` - пароль

Если этот прокси у вас не работает, то вы можете попросить бота дать вам другой и подставить его сюда. После всех манипуляций, можно наконец запустить бота

```
python bot.py
```


## Создание бота, сообщающего курс доллара на основе библиотеки pyTelegramBotAPI

    todo


## Создание бота для учета расходов на основе библиотеки python-telegram-bot

    todo


## Куда выложить бота чтобы он работал всегда

    todo


